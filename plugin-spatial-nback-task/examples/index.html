<!DOCTYPE html>
<html>
<head>
    <title>Spatial N-Back Task</title>
    <script src="https://unpkg.com/jspsych@8.2.1"></script>
    <script src="../src/index.js"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.1.0"></script>
    <link href="https://unpkg.com/jspsych@8.2.1/css/jspsych.css" rel="stylesheet" type="text/css" />
</head>
<body></body>
<script>

const jsPsych = initJsPsych({
    on_finish: function(data) {
        // Show custom summary first
      jsPsych.data.displayData();

      //displaySummary(data);
    }
});

// Instructions trial
const instructions = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
        <div style="text-align: center; font-size: 18px; line-height: 1.5;">
            <h2>Spatial N-Back Task</h2>
            <p>In this task, you will see a grid with blue squares appearing in different positions.</p>
            <p>Your job is to click the MATCH button whenever the current position is the same as the position from <strong>2 trials ago</strong>.</p>
            <p>Try to respond as quickly and accurately as possible.</p>
            <p>Press any key to begin the task.</p>
        </div>
    `,
    choices: "ALL_KEYS"
};

// Main N-back task
const nback_task = {
    type: jsPsychPluginSpatialNbackTask,
    rows: 3,
    cols: 3,
    n_back_level: 1,
    total_trials: 6,
    target_percentage: 25,
    stimulus_duration: 750000000,
    isi_duration: 250,
    show_feedback: true,
    show_progress: true,
    cell_size: 80
};

// Create timeline
const timeline = [instructions, nback_task];

// Custom function to display summary
function displaySummary(data) {
    const nback_data = data.filter({trial_type: 'plugin-spatial-nback-task'}).values()[0];
    
    if (nback_data) {
        const summary_html = `
            <div style="text-align: center; font-family: Arial, sans-serif; padding: 20px;">
                <h2>Task Complete!</h2>
                <div style="background-color: #f0f0f0; padding: 20px; border-radius: 10px; display: inline-block; margin: 20px;">
                    <h3>Your Performance:</h3>
                    <p><strong>Overall Accuracy:</strong> ${(nback_data.overall_accuracy * 100).toFixed(1)}%</p>
                    <p><strong>Hit Rate:</strong> ${(nback_data.hit_rate * 100).toFixed(1)}%</p>
                    <p><strong>False Alarm Rate:</strong> ${(nback_data.false_alarm_rate * 100).toFixed(1)}%</p>
                    <p><strong>Total Duration:</strong> ${(nback_data.total_duration / 1000).toFixed(1)} seconds</p>
                </div>
                <div style="margin-top: 20px;">
                    <button id="download-data-btn" style="padding: 10px 20px; font-size: 16px; margin: 5px;">Download Data</button>
                    <button id="show-raw-data-btn" style="padding: 10px 20px; font-size: 16px; margin: 5px;">Show Raw Data</button>                    
                    <button id="back-to-summary-btn" style="padding: 10px 20px; font-size: 16px; margin: 5px; display: none;">Back to Summary</button>
                </div>
                <div id="raw-data-container" style="display: none; margin-top: 20px; text-align: left;">
                    <h3>Raw Data (JSON):</h3>
                    <pre style="background-color: #f5f5f5; padding: 15px; border-radius: 5px; overflow: auto; max-height: 400px; text-align: left;">${JSON.stringify(data.values(), null, 2)}</pre>
                </div>
            </div>
        `;
        
        document.body.innerHTML = summary_html;
        
        // Add event listeners after HTML is inserted
        document.getElementById('show-raw-data-btn').addEventListener('click', showRawData);
        document.getElementById('download-data-btn').addEventListener('click', downloadData);
        document.getElementById('back-to-summary-btn').addEventListener('click', hideRawData);
    }
}

// Function to show raw data
function showRawData() {
    document.getElementById('raw-data-container').style.display = 'block';
    document.getElementById('show-raw-data-btn').style.display = 'none';
    document.getElementById('back-to-summary-btn').style.display = 'inline-block';
}

// Function to hide raw data
function hideRawData() {
    document.getElementById('raw-data-container').style.display = 'none';
    document.getElementById('show-raw-data-btn').style.display = 'inline-block';
    document.getElementById('back-to-summary-btn').style.display = 'none';
}

// Function to download data as CSV
function downloadData() {
    jsPsych.data.get().localSave('csv', 'nback_data.csv');
}

// Run the experiment
jsPsych.run(timeline);

</script>
</html>